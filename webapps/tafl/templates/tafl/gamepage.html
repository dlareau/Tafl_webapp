{% extends "tafl/interior_base.html" %}
{% block title %} Game Page {% endblock %}
{% load staticfiles %}
{% block scripts %}
<link rel="stylesheet" href="{% static 'tafl/gamepage.css' %}">
<script type="text/javascript" src="{% static 'tafl/ws4redis.js' %}"></script>
{% endblock %}
    
{% block content %}
  <div id="labels" class="col-md-2">
    <span id="id-opp"> <h3>Their name</h3> </span>
    <span id="resign-btn">
      <form action="/tafl/resign" method="post" onsubmit="return confirm('Are you sure you want to resign?');">
        {% csrf_token %}
        <input class="btn" type="submit" value="Resign">
      </form>
    </span>
    <span id="rules-btn"> <button class="btn">Rules</button> </span>
    <span id="id-you"> <h3> Your name</h3> </span>
  </div>
  <div id="board-container" class="col-md-7">
    {% regroup game.squares.all by x_coord as rows %}
    {% for row in rows %}
      <div class='board-row'>
        {% for cell in row.list|dictsort:"y_coord" %}
          <div data-id="[{{cell.x_coord}}, {{cell.y_coord}}]" class="board-cell">
            {% if cell.member.color == "BL" %}
              <div class="tafl-piece black"></div>
            {% elif cell.member.color == "WH" %}
              <div class="tafl-piece white"></div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <div id="chat" class="col-md-3">
    <h2>Chat</h2>
    <hr>
    <form class="form" action="{% url 'game' %}" method="post">
      {% csrf_token %}
      <input type="text" id="inputUserPost" name="text" class="form-control" 
       placeholder="Chat here" required autofocus>
      <button id="ChatPostButton" class="btn btn-primary" type="submit">Submit</button>
    </form>
  </div>
  <script>
    var clicked = false;
    var piece = null;
    var dest = null;

    function getCookie(c_name){
      if (document.cookie.length > 0)
      {
        c_start = document.cookie.indexOf(c_name + "=");
        if (c_start != -1)
        {
          c_start = c_start + c_name.length + 1;
          c_end = document.cookie.indexOf(";", c_start);
          if (c_end == -1) c_end = document.cookie.length;
          return unescape(document.cookie.substring(c_start,c_end));
        }
      }
      return "";
    }

    $(function () {
      $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      });
    });

    $('.board-cell').click(function(event) {
      if(clicked){  
        dest = $(this);
        $.ajax({
          type: 'POST',
          url: "{% url 'game' %}",
          data: {move: "[" + piece.parent().attr('data-id') + ", " + $(this).attr('data-id') + "]"},
          success: function (html) {
            console.log(piece.parent().attr('data-id') + " => " + dest.attr('data-id'));
            if(html == "valid"){
              var temp = piece.detach();
              dest.append(temp);
            }
            else{
              console.log(html);
            }
          },
          error: function (html) {
            console.log(html);
          }
        });
        clicked = false;
      }
    });

    $('.tafl-piece').click(function(event) {
      event.stopPropagation();
      clicked = true;
      piece = $(this);

    });

    jQuery(document).ready(function($) {
      var ws4redis = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}game_move?subscribe-user',
        receive_message: receiveMessage,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
      });
    });

    function receiveMessage(msg) {
      //TODO: Neater
      src = $('[data-id="' + msg.slice(1,7) + '"]').children(":first");
      dst = $('[data-id="' + msg.slice(9,15) + '"]');
      var temp = src.detach();
      dst.append(temp);
    }
  </script>
{% endblock %}