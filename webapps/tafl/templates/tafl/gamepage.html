{% extends "tafl/interior_base.html" %}
{% block title %} Game Page {% endblock %}
{% load staticfiles %}
{% block scripts %}
<link rel="stylesheet" href="{% static 'tafl/gamepage.css' %}">
<script type="text/javascript" src="{% static 'tafl/ws4redis.js' %}"></script>
{% endblock %}
    
{% block content %}
  <div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
        <h4 class="modal-title">Waiting on other player</h4>
        </div>
        <div class="modal-body">
          <p>Please wait until another player joins your game. </p>
          <p>In the future there will be an option to cancel this game. </p>
        </div>
      </div>

    </div>
  </div>

  <div id="labels" class="col-md-2">
    <span id="resign-btn">
      <form action="/tafl/resign" method="post" onsubmit="return confirm('Are you sure you want to resign?');">
        {% csrf_token %}
        <input class="btn" type="submit" value="Resign">
      </form>
    </span>
    <span id="rules-btn"> 
      <script>
	function giveRules() {
	    console.log("rules");
	    alert("White - get your king to an edge square \n Black - capture the king by surrounding it on all 4 sides \n to capture a pawn - bracket on 2 sides. note, king can't capture \n all pieces move as far as is open horizontally or vertically \n can't move on corners or the throne (but can move through the throne)");
	}
      </script>
      <button class="btn" onclick="giveRules()">Rules</button> 
    </span>
    {% if game.white_player == player%}
      <span id="id-you"> 
        <h3>You:</h3>
        <h3>{{game.white_player.user.username}}</h3> 
      </span>
      <span id="id-opp">
        <h3>Opponent:</h3>
        <h3 id="opponent_title">{{game.black_player.user.username}}</h3>
      </span>
    {% else %}
      <span id="id-you">
        <h3>You:</h3>
        <h3>{{game.black_player.user.username}}</h3>
      </span>
      <span id="id-opp">
        <h3>Opponent:</h3>
        <h3>{{game.white_player.user.username}}</h3>
      </span>
    {% endif %}
  </div>
  <div id="board-container" class="col-md-7">
    {% regroup game.squares.all by x_coord as rows %}
    {% for row in rows %}
      <div class='board-row'>
        {% for cell in row.list|dictsort:"y_coord" %}
          <div data-id="[{{cell.x_coord}}, {{cell.y_coord}}]" class="board-cell">
            {% if cell.member.color == "BL" %}
              <div class="tafl-piece black">
            {% elif cell.member.color == "WH" %}
              <div class="tafl-piece white">
            {% endif %}
            {% if cell.member.p_type == "KING" %}
              KING
            {% endif %}
            {% if cell.member.color == "BL" %}
              </div>
            {% elif cell.member.color == "WH" %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <div id="chat" class="col-md-3">
    <h2>Chat</h2>
    <hr>
    <div id="chat_messages" style="word-wrap: break-word;">
    </div>
    <form id="chatForm" class="form" action="{% url 'sendMessage' %}" method="post">
      {% csrf_token %}
      <input type="text" id="inputUserPost" name="text" class="form-control" 
       placeholder="Chat here" required autofocus>
      <button id="ChatPostButton" class="btn btn-primary" type="submit">Submit</button>
    </form>
  </div>
  <script>
    var clicked = false;
    var piece = null;
    var dest = null;

    function getCookie(c_name){
      if (document.cookie.length > 0)
      {
        c_start = document.cookie.indexOf(c_name + "=");
        if (c_start != -1)
        {
          c_start = c_start + c_name.length + 1;
          c_end = document.cookie.indexOf(";", c_start);
          if (c_end == -1) c_end = document.cookie.length;
          return unescape(document.cookie.substring(c_start,c_end));
        }
      }
      return "";
    }

    $(function () {
      $.ajaxSetup({
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      });
    });

    $('#chatForm').on('submit', function (e) {
      e.preventDefault();
      $.ajax({
        type: 'post',
        url: "{% url 'sendMessage' %}",
        data: $("#chatForm").serialize(),
        error: function (html) {
          console.log(html);
        }
      });
    });

    $('.board-cell').click(function(event) {
      if(clicked){  
        dest = $(this);
        $.ajax({
          type: 'POST',
          url: "{% url 'game' %}",
          data: {move: "[" + piece.parent().attr('data-id') + ", " + $(this).attr('data-id') + "]"},
          success: function (html) {
            console.log(piece.parent().attr('data-id') + " => " + dest.attr('data-id'));
            if(html == "valid"){
              var temp = piece.detach();
              dest.append(temp);
            }
            else{
              console.log(html);
            }
          },
          error: function (html) {
            console.log(html);
          }
        });
        clicked = false;
      }
    });

    $('.tafl-piece').click(function(event) {
      event.stopPropagation();
      clicked = true;
      piece = $(this);

    });

    //========= FORMS/MOVES /\ ================

    //=========  WEBSOCKETS \/ ================

    {% if game.waiting_player %}
      jQuery(document).ready(function($) {
        $("#myModal").modal({backdrop: "static"});
      });
    {% endif %}

    jQuery(document).ready(function($) {
      var ws4redis = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}game_move?subscribe-user',
        receive_message: receiveMessage_move,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
      });

      var ws4redis2 = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}chat?subscribe-user',
        receive_message: receiveMessage_chat,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
      });

      var ws4redis3 = WS4Redis({
        uri: '{{ WEBSOCKET_URI }}game_join?subscribe-user',
        receive_message: receiveMessage_join,
        heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
      });
    });

    function receiveMessage_move(msg) {
      //TODO: Neater
      msg = JSON.parse(msg)
      if(msg["capture"]){
        console.log("Capture " + msg['pos'][0] + ", " + msg['pos'][1]);
        src = $('[data-id="[' + msg['pos'][0] + ", " + msg['pos'][1] + ']"]').children(":first");
        src.detach();
      } else{
        console.log("Moved")
        src = $('[data-id="[' + msg['move'][0][0] + ", " + msg['move'][0][1] + ']"]').children(":first");
        dst = $('[data-id="[' + msg['move'][1][0] + ", " + msg['move'][1][1] + ']"]');
        var temp = src.detach();
        dst.append(temp);
      }
    }

    function receiveMessage_chat(msg) {
      msg = JSON.parse(msg);
      $("#chat_messages").append(msg['name'] + ": " + msg['text'] + "<br>")
    }

    function receiveMessage_join(msg) {
      msg = JSON.parse(msg);
      $("#myModal").modal("hide");
      $("#opponent_title").html(msg);
    }

    $(window).resize(function() {
      size = ($("#board-container").width()-36)/9
      $(".board-cell").width(size);
      $(".board-cell").height(size);
    });
  </script>
{% endblock %}
